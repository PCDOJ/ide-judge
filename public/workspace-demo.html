<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workspace Demo - IDE Judge</title>
    <link rel="stylesheet" href="/css/workspace.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Workspace Toolbar -->
    <div class="workspace-toolbar">
        <div class="toolbar-left">
            <button class="btn-workspace btn-back" onclick="goBack()">
                <i class="fas fa-arrow-left"></i> Quay lại
            </button>
            <div class="problem-info">
                <span class="problem-code" id="problem-code">PROB001</span>
                <span> - </span>
                <span id="problem-title">Tổng hai số</span>
            </div>

            <!-- Monitoring Panel -->
            <div class="monitoring-panel" id="monitoringPanel">
                <div class="monitoring-status">
                    <i class="fas fa-shield-check"></i>
                    <span>ĐANG GIÁM SÁT</span>
                </div>
                <div class="time-info">
                    <div class="time-item">
                        <div class="time-label">Giờ hiện tại</div>
                        <div class="time-value" id="currentTime">--:--:--</div>
                    </div>
                    <div class="time-item">
                        <div class="time-label">Còn lại</div>
                        <div class="time-value" id="countdown">--:--:--</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="toolbar-right">
            <div class="timer" id="timer">
                <i class="fas fa-clock"></i>
                <span id="time-remaining">--:--:--</span>
            </div>
            <button class="btn-workspace btn-view-pdf" onclick="togglePDF()" id="view-pdf-btn" style="display: none;">
                <i class="fas fa-file-pdf"></i> Đề bài
            </button>
            <button class="btn-workspace btn-run" onclick="showRunCodeModal()" style="background: #28a745;">
                <i class="fas fa-play"></i> Run Code
            </button>
            <button class="btn-workspace btn-save" onclick="saveManually()">
                <i class="fas fa-save"></i> Lưu
            </button>
            <button class="btn-workspace btn-submit" onclick="submitCode()">
                <i class="fas fa-paper-plane"></i> Nộp bài
            </button>
        </div>
    </div>

    <!-- Sync Status -->
    <div id="sync-status" class="sync-status idle"></div>

    <!-- Toggle Sidebar Button -->
    <button class="toggle-sidebar-btn" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- File List Sidebar -->
    <div class="file-list-sidebar" id="file-sidebar">
        <div class="sidebar-header">
            <span>Files</span>
            <div style="display: flex; align-items: center; gap: 10px;">
                <button onclick="refreshFileList()" class="btn-refresh-files" title="Refresh file list">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <span id="files-count">0</span>
            </div>
        </div>
        <div id="file-list">
            <!-- Files will be loaded here -->
        </div>
    </div>

    <!-- Split Container for PDF and Workspace -->
    <div class="split-container">
        <!-- PDF Panel -->
        <div class="pdf-panel hidden" id="pdfPanel">
            <iframe id="pdfViewer" class="pdf-viewer"></iframe>
        </div>

        <!-- Resize Handle -->
        <div class="resize-handle hidden" id="resizeHandle"></div>

        <!-- Workspace Container -->
        <div class="workspace-container fullscreen" id="workspaceContainer">
            <!-- Code-server iframe sẽ được load ở đây -->
            <iframe id="workspace-iframe" class="workspace-iframe" src="about:blank"></iframe>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="workspace-loading" id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">Đang khởi tạo workspace...</div>
    </div>

    <!-- Run Code Modal -->
    <div class="modal fade" id="runCodeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-play"></i> Run Code
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Chọn file cần run:</label>
                        <select class="form-select" id="file-selector">
                            <option value="">-- Chọn file --</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ngôn ngữ: <strong id="detected-language">-</strong></label>
                    </div>
                    <div class="mb-3" id="cpp-version-selector" style="display: none;">
                        <label class="form-label">C++ Version:</label>
                        <select class="form-select" id="cpp-version">
                            <option value="c++14">C++14</option>
                            <option value="c++17">C++17</option>
                            <option value="c++20" selected>C++20 (Default)</option>
                            <option value="c++23">C++23</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="show-popup-output" value="">
                            <label class="form-check-label" for="show-popup-output">
                                <i class="fas fa-window-restore"></i> Chạy qua Judge0 (có thể nhập input)
                            </label>
                        </div>
                        <small class="text-muted">
                            Nếu không chọn, code sẽ chạy trực tiếp trong code-server container
                        </small>
                    </div>
                    <div class="mb-3" id="stdin-input-container" style="display: none;">
                        <label class="form-label">
                            <i class="fas fa-keyboard"></i> Input (stdin):
                        </label>
                        <textarea class="form-control" id="stdin-input" rows="4" placeholder="Nhập input cho chương trình (nếu cần)..."></textarea>
                        <small class="text-muted">
                            Nếu để trống, hệ thống sẽ sử dụng input từ file input.txt
                        </small>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <span id="run-mode-info">Code sẽ được compile và run trực tiếp trong code-server container. Kết quả hiển thị trong popup.</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-success" onclick="runCode()">
                        <i class="fas fa-play"></i> Run
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Global Exam Monitoring -->
    <script src="/js/exam-monitoring.js"></script>
    <!-- Global Exam Notification -->
    <script src="/js/global-exam-notification.js"></script>

    <script src="/js/workspace-client.js"></script>
    <script>
        // Global variables
        let workspaceClient = null;
        let contestId = null;
        let problemId = null;
        let problemCode = null;
        window.codeSaved = false; // Track if code has been saved

        // Initialize workspace khi page load
        window.addEventListener('DOMContentLoaded', async () => {
            // Get params from URL
            const urlParams = new URLSearchParams(window.location.search);
            contestId = parseInt(urlParams.get('contestId'));
            problemId = parseInt(urlParams.get('problemId'));
            problemCode = urlParams.get('problemCode');

            // Validate required parameters
            if (!contestId || !problemId) {
                alert('Thiếu thông tin contestId hoặc problemId. Vui lòng mở workspace từ trang exam.');
                window.location.href = '/exams.html';
                return;
            }

            // Set default problemCode if not provided
            if (!problemCode) {
                problemCode = 'PROB' + String(problemId).padStart(3, '0');
            }

            console.log('[Workspace] Initialized with:', { contestId, problemId, problemCode });

            // Update UI
            document.getElementById('problem-code').textContent = problemCode;

            try {
                // Initialize workspace client
                workspaceClient = new WorkspaceClient();
                const session = await workspaceClient.init(contestId, problemId);

                console.log('Workspace initialized:', session);

                // Load code-server iframe directly from port 8080 to avoid proxy origin issues
                const folderPath = `/workspace/${session.workspacePath}`;
                const codeServerUrl = `http://localhost:8080/?folder=${encodeURIComponent(folderPath)}`;

                console.log('[Workspace] Loading code-server iframe:', {
                    folderPath: folderPath,
                    encodedUrl: codeServerUrl,
                    sessionId: session.sessionId,
                    workspacePath: session.workspacePath
                });

                const iframe = document.getElementById('workspace-iframe');

                // Add load event listener to track iframe loading
                iframe.addEventListener('load', () => {
                    console.log('[Workspace] Code-server iframe loaded successfully');
                });

                iframe.addEventListener('error', (e) => {
                    console.error('[Workspace] Code-server iframe load error:', e);
                });

                iframe.src = codeServerUrl;

                // Load file list
                await loadFileList();

                // Start auto-refresh file list
                startAutoRefresh();

                // Start timer
                startTimer(session);

                // Show PDF button (always show since all problems should have PDF)
                document.getElementById('view-pdf-btn').style.display = 'inline-block';

                // Hide loading overlay
                document.getElementById('loading-overlay').style.display = 'none';

                // Initialize exam monitoring if required
                await initializeExamMonitoring();

            } catch (error) {
                console.error('Workspace initialization error:', error);
                alert('Không thể khởi tạo workspace: ' + error.message);
            }
        });

        // Initialize exam monitoring
        async function initializeExamMonitoring() {
            try {
                console.log('[Workspace] Checking exam monitoring status...');

                // Get exam information
                const examResponse = await fetch(`/api/user/exams/${contestId}`);
                const examData = await examResponse.json();

                if (!examData.success || !examData.exam) {
                    console.log('[Workspace] Could not fetch exam data');
                    return;
                }

                const exam = examData.exam;
                console.log('[Workspace] Exam data:', exam);

                // Check monitoring status
                const monitoringResponse = await fetch(`/api/user/exams/${contestId}/monitoring-status`);
                const monitoringData = await monitoringResponse.json();

                console.log('[Workspace] Monitoring status:', monitoringData);

                if (monitoringData.success && monitoringData.shouldMonitor) {
                    console.log('[Workspace] Enabling exam monitoring...');

                    // Enable monitoring module
                    if (window.ExamMonitoring) {
                        window.ExamMonitoring.enable(
                            contestId,
                            exam.title,
                            exam.end_time
                        );

                        // Set problem ID for violation tracking
                        if (problemId) {
                            window.ExamMonitoring.setProblemId(problemId);
                        }

                        console.log('[Workspace] ✓ Exam monitoring enabled (problem:', problemId, ')');

                        // Show monitoring panel
                        const panel = document.getElementById('monitoringPanel');
                        if (panel) {
                            panel.classList.add('active');
                        }

                        // Hide old timer when monitoring panel is shown
                        const oldTimer = document.getElementById('timer');
                        if (oldTimer) {
                            oldTimer.style.display = 'none';
                        }

                        // Start clock updates
                        initMonitoringClock(exam.end_time);
                    } else {
                        console.error('[Workspace] ✗ ExamMonitoring module not loaded!');
                    }
                } else {
                    console.log('[Workspace] Monitoring not required:', monitoringData.reason || 'No reason provided');
                }
            } catch (error) {
                console.error('[Workspace] Error initializing exam monitoring:', error);
            }
        }

        // Load file list
        async function loadFileList() {
            try {
                const response = await fetch(`/api/workspace/files/${contestId}/${problemId}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message);
                }

                const fileList = document.getElementById('file-list');
                fileList.innerHTML = '';

                if (data.files.length === 0) {
                    fileList.innerHTML = '<div style="padding: 15px; color: #6c757d; text-align: center;">Chưa có file nào</div>';
                } else {
                    data.files.forEach(file => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item' + (file.is_main_file ? ' main-file' : '');

                        // Lấy icon và màu dựa trên đuôi file thực tế
                        const fileIcon = getFileIcon(file.file_name);
                        const fileColor = getFileColor(file.file_name);

                        fileItem.innerHTML = `
                            <i class="${fileIcon} file-icon" style="color: ${fileColor};"></i>
                            <span class="file-name">${file.file_name}</span>
                            <span class="file-size">(${formatFileSize(file.file_size)})</span>
                        `;
                        fileList.appendChild(fileItem);
                    });
                }

                document.getElementById('files-count').textContent = data.files.length;

            } catch (error) {
                console.error('Load file list error:', error);
            }
        }

        // Helper: Lấy icon cho file dựa trên extension
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const iconMap = {
                'cpp': 'fab fa-cuttlefish',
                'c': 'fab fa-cuttlefish',
                'h': 'fas fa-file-code',
                'hpp': 'fas fa-file-code',
                'py': 'fab fa-python',
                'java': 'fab fa-java',
                'js': 'fab fa-js-square',
                'ts': 'fas fa-file-code',
                'go': 'fas fa-file-code',
                'rs': 'fas fa-file-code',
                'txt': 'fas fa-file-alt',
                'md': 'fab fa-markdown',
                'json': 'fas fa-file-code',
                'sh': 'fas fa-terminal'
            };
            return iconMap[ext] || 'fas fa-file-code';
        }

        // Helper: Lấy màu cho file dựa trên extension
        function getFileColor(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const colorMap = {
                'cpp': '#00599C',
                'c': '#555555',
                'h': '#A8B9CC',
                'hpp': '#A8B9CC',
                'py': '#3776AB',
                'java': '#007396',
                'js': '#F7DF1E',
                'ts': '#3178C6',
                'go': '#00ADD8',
                'rs': '#CE422B',
                'txt': '#6c757d',
                'md': '#083FA1',
                'json': '#292929',
                'sh': '#4EAA25'
            };
            return colorMap[ext] || '#667eea';
        }

        // Save manually
        async function saveManually() {
            try {
                // Sync files to server first
                await workspaceClient.syncToServer();

                // Save code to submission
                const response = await fetch('/api/workspace/save-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: workspaceClient.sessionId,
                        contestId: contestId,
                        problemId: problemId
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message);
                }

                await loadFileList();

                // Show success notification
                showNotification('success', 'Đã lưu thành công!');

                // Mark as saved
                window.codeSaved = true;

            } catch (error) {
                console.error('Save error:', error);
                showNotification('error', 'Lưu thất bại: ' + error.message);
            }
        }

        // Submit code
        async function submitCode() {
            if (!confirm('Bạn có chắc muốn nộp bài? Sau khi nộp bạn không thể chỉnh sửa.')) {
                return;
            }

            try {
                const result = await workspaceClient.submitCode();
                alert(`Nộp bài thành công!\n\nSố files: ${result.filesCount}\nFile chính: ${result.mainFile}`);

                // Redirect về trang exam
                setTimeout(() => {
                    window.location.href = `/exam-view.html?id=${contestId}`;
                }, 2000);

            } catch (error) {
                console.error('Submit error:', error);
                alert('Nộp bài thất bại: ' + error.message);
            }
        }

        // Toggle PDF panel
        function togglePDF() {
            const pdfPanel = document.getElementById('pdfPanel');
            const workspaceContainer = document.getElementById('workspaceContainer');
            const resizeHandle = document.getElementById('resizeHandle');
            const toggleBtn = document.getElementById('view-pdf-btn');
            const pdfViewer = document.getElementById('pdfViewer');

            if (pdfPanel.classList.contains('hidden')) {
                // Show PDF
                pdfPanel.classList.remove('hidden');
                workspaceContainer.classList.remove('fullscreen');
                resizeHandle.classList.remove('hidden');
                pdfPanel.style.width = '50%';
                workspaceContainer.style.width = '50%';
                toggleBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Ẩn đề';

                // Load PDF if not loaded yet
                if (!pdfViewer.src || pdfViewer.src === 'about:blank') {
                    pdfViewer.src = `/api/user/problems/${problemId}/pdf#zoom=100`;
                }
            } else {
                // Hide PDF
                pdfPanel.classList.add('hidden');
                pdfPanel.style.width = '0';
                workspaceContainer.classList.add('fullscreen');
                workspaceContainer.style.width = '100%';
                resizeHandle.classList.add('hidden');
                toggleBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Đề bài';
            }
        }

        // Go back
        function goBack() {
            console.log('[Workspace] goBack() called, contestId:', contestId);

            // Validate contestId before redirect
            if (!contestId) {
                console.error('[Workspace] contestId is undefined, redirecting to exams.html');
                window.location.href = '/exams.html';
                return;
            }

            const redirectUrl = `/exam-view.html?id=${contestId}`;
            console.log('[Workspace] Redirecting to:', redirectUrl);

            // IMPORTANT: KHÔNG dừng exam monitoring ở đây
            // Vì user vẫn đang trong kỳ thi, chỉ chuyển từ workspace về exam-view
            // Module exam-monitoring.js sẽ tự động tiếp tục giám sát trên trang exam-view.html
            // Chỉ disable monitoring khi user thực sự rời khỏi kỳ thi (leave exam)

            // Nếu đã lưu thì không hỏi lại
            if (window.codeSaved) {
                window.location.href = redirectUrl;
                return;
            }

            // Nếu chưa lưu thì hỏi
            if (confirm('Bạn có chắc muốn thoát? Code chưa được lưu.')) {
                window.location.href = redirectUrl;
            }
        }

        // Show notification
        function showNotification(type, message) {
            // Tạo notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span>${message}</span>
            `;

            // Thêm vào body
            document.body.appendChild(notification);

            // Hiện notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // Ẩn sau 3 giây
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('file-sidebar');
            sidebar.classList.toggle('collapsed');
        }

        // Refresh file list manually
        async function refreshFileList() {
            try {
                const btn = event.target.closest('.btn-refresh-files');
                const icon = btn.querySelector('i');

                // Add spinning animation
                icon.classList.add('fa-spin');
                btn.disabled = true;

                const response = await fetch('/api/workspace/refresh-files', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: workspaceClient.sessionId,
                        contestId: contestId,
                        problemId: problemId
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message);
                }

                // Update file list UI
                const fileList = document.getElementById('file-list');
                fileList.innerHTML = '';

                if (data.files.length === 0) {
                    fileList.innerHTML = '<div style="padding: 15px; color: #6c757d; text-align: center;">Chưa có file nào</div>';
                } else {
                    data.files.forEach(file => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item' + (file.is_main_file ? ' main-file' : '');

                        const fileIcon = getFileIcon(file.file_name);
                        const fileColor = getFileColor(file.file_name);

                        fileItem.innerHTML = `
                            <i class="${fileIcon} file-icon" style="color: ${fileColor};"></i>
                            <span class="file-name">${file.file_name}</span>
                            <span class="file-size">(${formatFileSize(file.file_size)})</span>
                        `;
                        fileList.appendChild(fileItem);
                    });
                }

                document.getElementById('files-count').textContent = data.files.length;

                console.log('[Workspace] File list refreshed:', data.filesCount, 'files');

            } catch (error) {
                console.error('Refresh file list error:', error);
                showNotification('error', 'Không thể refresh file list: ' + error.message);
            } finally {
                // Remove spinning animation
                const btn = event.target.closest('.btn-refresh-files');
                const icon = btn.querySelector('i');
                icon.classList.remove('fa-spin');
                btn.disabled = false;
            }
        }

        // Auto-refresh file list every 5 seconds
        let autoRefreshInterval = null;
        function startAutoRefresh() {
            // Clear existing interval if any
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }

            // Refresh every 5 seconds
            autoRefreshInterval = setInterval(async () => {
                try {
                    await loadFileList();
                } catch (error) {
                    console.error('Auto-refresh error:', error);
                }
            }, 5000);

            console.log('[Workspace] Auto-refresh started (every 5 seconds)');
        }

        // Stop auto-refresh when leaving page
        window.addEventListener('beforeunload', () => {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        });

        // Start timer
        function startTimer(session) {
            // TODO: Implement countdown timer based on session.expiresAt
            const timerElement = document.getElementById('time-remaining');
            
            function updateTimer() {
                // Placeholder - replace with actual logic
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                timerElement.textContent = `${hours}:${minutes}:${seconds}`;
            }

            updateTimer();
            setInterval(updateTimer, 1000);
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Listen to workspace sync status
        window.addEventListener('workspace-sync-status', (e) => {
            console.log('Sync status:', e.detail.status);
            
            // Reload file list after successful sync
            if (e.detail.status === 'saved') {
                loadFileList();
            }
        });

        // Cleanup khi unload
        window.addEventListener('beforeunload', () => {
            if (workspaceClient) {
                workspaceClient.destroy();
            }
        });

        // Show Run Code Modal
        async function showRunCodeModal() {
            try {
                // Get files to populate dropdown
                const response = await fetch(`/api/workspace/files/${contestId}/${problemId}`);
                const data = await response.json();

                if (!data.success || data.files.length === 0) {
                    alert('Không tìm thấy file code. Vui lòng tạo file trước.');
                    return;
                }

                // Populate file selector
                const fileSelector = document.getElementById('file-selector');
                fileSelector.innerHTML = '<option value="">-- Chọn file --</option>';

                // Filter code files only
                const codeExtensions = ['cpp', 'c', 'py', 'java', 'js', 'go', 'rs'];
                const codeFiles = data.files.filter(f => {
                    const ext = f.file_name.split('.').pop().toLowerCase();
                    return codeExtensions.includes(ext);
                });

                if (codeFiles.length === 0) {
                    alert('Không tìm thấy file code hợp lệ.');
                    return;
                }

                // Add files to dropdown
                codeFiles.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file.file_name;
                    option.textContent = file.file_name;
                    if (file.is_main_file) {
                        option.textContent += ' (Main)';
                        option.selected = true;
                    }
                    fileSelector.appendChild(option);
                });

                // Auto-select first file if no main file
                if (!codeFiles.find(f => f.is_main_file)) {
                    fileSelector.selectedIndex = 1; // Skip "-- Chọn file --"
                }

                // Update language when file changes
                fileSelector.addEventListener('change', updateLanguageDisplay);

                // Initial language display
                updateLanguageDisplay();

                // Setup checkbox event listener
                const showPopupCheckbox = document.getElementById('show-popup-output');
                const runModeInfo = document.getElementById('run-mode-info');
                const stdinInputContainer = document.getElementById('stdin-input-container');

                showPopupCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        runModeInfo.innerHTML = '<i class="fas fa-window-restore"></i> Code sẽ được chạy qua Judge0 và kết quả hiển thị trong popup riêng với logs đầy đủ.';
                        stdinInputContainer.style.display = 'block'; // Hiển thị input field
                    } else {
                        runModeInfo.innerHTML = '<i class="fas fa-terminal"></i> Code sẽ được compile và run trực tiếp trong code-server container. Kết quả hiển thị trong popup.';
                        stdinInputContainer.style.display = 'none'; // Ẩn input field
                    }
                });

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('runCodeModal'));
                modal.show();

            } catch (error) {
                console.error('Error showing run modal:', error);
                alert('Lỗi khi mở modal: ' + error.message);
            }
        }

        // Update language display based on selected file
        function updateLanguageDisplay() {
            const fileSelector = document.getElementById('file-selector');
            const selectedFile = fileSelector.value;

            if (!selectedFile) {
                document.getElementById('detected-language').textContent = '-';
                document.getElementById('cpp-version-selector').style.display = 'none';
                return;
            }

            const ext = selectedFile.split('.').pop().toLowerCase();

            // Detect language
            const languageMap = {
                'cpp': 'C++',
                'c': 'C',
                'py': 'Python',
                'java': 'Java',
                'js': 'JavaScript',
                'go': 'Go',
                'rs': 'Rust'
            };

            const language = languageMap[ext] || 'Unknown';
            document.getElementById('detected-language').textContent = language;

            // Show C++ version selector only for C++
            const cppSelector = document.getElementById('cpp-version-selector');
            if (ext === 'cpp' || ext === 'c') {
                cppSelector.style.display = 'block';
            } else {
                cppSelector.style.display = 'none';
            }
        }

        // Run Code
        async function runCode() {
            try {
                const fileSelector = document.getElementById('file-selector');
                const selectedFile = fileSelector.value;

                if (!selectedFile) {
                    alert('Vui lòng chọn file cần run.');
                    return;
                }

                const cppVersion = document.getElementById('cpp-version').value;
                const showPopup = document.getElementById('show-popup-output').checked;

                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('runCodeModal'));
                modal.hide();

                // Show loading
                showNotification('info', 'Đang tạo script chạy code...');

                // Call API to create run script
                const response = await fetch('/api/workspace/run-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contestId: contestId,
                        problemId: problemId,
                        fileName: selectedFile,
                        cppVersion: cppVersion,
                        showPopup: showPopup
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    alert('Lỗi: ' + data.message);
                    return;
                }

                if (showPopup) {
                    // Mode popup: Chạy code và hiển thị kết quả trong popup
                    showNotification('info', 'Đang chạy code...');

                    // Lấy stdin từ textarea
                    const stdinInput = document.getElementById('stdin-input').value;

                    // Execute code và lấy output
                    const executeResponse = await fetch('/api/workspace/execute-code', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contestId: contestId,
                            problemId: problemId,
                            fileName: selectedFile,
                            cppVersion: cppVersion,
                            stdin: stdinInput
                        })
                    });

                    const executeData = await executeResponse.json();

                    if (!executeData.success) {
                        alert('Lỗi khi chạy code: ' + executeData.message);
                        return;
                    }

                    // Hiển thị kết quả trong popup
                    showCodeOutputPopup(executeData.data);

                } else {
                    // Mode terminal: Execute trực tiếp trong container
                    const fullCommand = data.data.command;

                    showNotification('info', 'Đang chạy code trong terminal...');

                    // Execute command trong code-server container
                    const executeResponse = await fetch('/api/workspace/execute-in-terminal', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contestId: contestId,
                            problemId: problemId,
                            command: fullCommand
                        })
                    });

                    const executeData = await executeResponse.json();

                    // Hiển thị kết quả trong popup (giống như popup mode)
                    const outputData = {
                        success: executeData.success,
                        fileName: data.data.fileName,
                        language: data.data.language,
                        compileOutput: '',
                        compileError: false,
                        compileTime: 0,
                        stdout: executeData.data.stdout || '',
                        stderr: executeData.data.stderr || '',
                        exitCode: executeData.success ? 0 : 1,
                        executionTime: 0,
                        error: executeData.data.error || null,
                        statusDescription: executeData.success ? 'Executed successfully' : 'Execution failed'
                    };

                    showCodeOutputPopup(outputData);
                }

            } catch (error) {
                console.error('Run code error:', error);
                alert('Lỗi khi chạy code: ' + error.message);
            }
        }

        // Show Code Output Popup
        function showCodeOutputPopup(outputData) {
            // Create popup window
            const popupWidth = 900;
            const popupHeight = 700;
            const left = (screen.width - popupWidth) / 2;
            const top = (screen.height - popupHeight) / 2;

            const popup = window.open('', 'CodeOutput',
                `width=${popupWidth},height=${popupHeight},left=${left},top=${top},resizable=yes,scrollbars=yes`);

            if (!popup) {
                alert('Popup bị chặn! Vui lòng cho phép popup cho trang này.');
                return;
            }

            // Build HTML content for popup
            const htmlContent = `
                <!DOCTYPE html>
                <html lang="vi">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Code Output - ${outputData.fileName}</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
                    <style>
                        body {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            background: #f5f5f5;
                            padding: 20px;
                        }
                        .output-container {
                            background: white;
                            border-radius: 8px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                            padding: 20px;
                            margin-bottom: 20px;
                        }
                        .output-header {
                            border-bottom: 2px solid #e9ecef;
                            padding-bottom: 15px;
                            margin-bottom: 20px;
                        }
                        .output-section {
                            margin-bottom: 20px;
                        }
                        .output-section h6 {
                            color: #495057;
                            font-weight: 600;
                            margin-bottom: 10px;
                        }
                        .code-block {
                            background: #2d2d2d;
                            color: #f8f8f2;
                            padding: 15px;
                            border-radius: 6px;
                            font-family: 'Courier New', monospace;
                            font-size: 14px;
                            white-space: pre-wrap;
                            word-wrap: break-word;
                            max-height: 400px;
                            overflow-y: auto;
                        }
                        .success-output {
                            border-left: 4px solid #28a745;
                        }
                        .error-output {
                            border-left: 4px solid #dc3545;
                        }
                        .status-badge {
                            display: inline-block;
                            padding: 5px 15px;
                            border-radius: 20px;
                            font-weight: 600;
                            font-size: 14px;
                        }
                        .status-success {
                            background: #d4edda;
                            color: #155724;
                        }
                        .status-error {
                            background: #f8d7da;
                            color: #721c24;
                        }
                        .info-row {
                            display: flex;
                            justify-content: space-between;
                            padding: 8px 0;
                            border-bottom: 1px solid #f0f0f0;
                        }
                        .info-label {
                            font-weight: 600;
                            color: #6c757d;
                        }
                        .info-value {
                            color: #212529;
                        }
                    </style>
                </head>
                <body>
                    <div class="output-container">
                        <div class="output-header">
                            <h4><i class="fas fa-terminal"></i> Kết quả chạy code</h4>
                            <div class="mt-2">
                                <span class="status-badge ${outputData.success ? 'status-success' : 'status-error'}">
                                    ${outputData.success ? '✓ Thành công' : '✗ Lỗi'}
                                </span>
                            </div>
                        </div>

                        <div class="output-section">
                            <h6><i class="fas fa-info-circle"></i> Thông tin</h6>
                            <div class="info-row">
                                <span class="info-label">File:</span>
                                <span class="info-value">${outputData.fileName}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Ngôn ngữ:</span>
                                <span class="info-value">${outputData.language}</span>
                            </div>
                            ${outputData.compileTime ? `
                            <div class="info-row">
                                <span class="info-label">Thời gian compile:</span>
                                <span class="info-value">${outputData.compileTime}ms</span>
                            </div>
                            ` : ''}
                            ${outputData.executionTime ? `
                            <div class="info-row">
                                <span class="info-label">Thời gian chạy:</span>
                                <span class="info-value">${outputData.executionTime}ms</span>
                            </div>
                            ` : ''}
                            ${outputData.memory ? `
                            <div class="info-row">
                                <span class="info-label">Bộ nhớ sử dụng:</span>
                                <span class="info-value">${outputData.memory} KB</span>
                            </div>
                            ` : ''}
                            ${outputData.statusDescription ? `
                            <div class="info-row">
                                <span class="info-label">Trạng thái:</span>
                                <span class="info-value">${outputData.statusDescription}</span>
                            </div>
                            ` : ''}
                            <div class="info-row">
                                <span class="info-label">Exit code:</span>
                                <span class="info-value">${outputData.exitCode || 0}</span>
                            </div>
                        </div>

                        ${outputData.compileOutput ? `
                        <div class="output-section">
                            <h6><i class="fas fa-cog"></i> Compile Output</h6>
                            <div class="code-block ${outputData.compileError ? 'error-output' : 'success-output'}">
${outputData.compileOutput}
                            </div>
                        </div>
                        ` : ''}

                        ${outputData.stdout ? `
                        <div class="output-section">
                            <h6><i class="fas fa-check-circle"></i> Standard Output</h6>
                            <div class="code-block success-output">
${outputData.stdout}
                            </div>
                        </div>
                        ` : ''}

                        ${outputData.stderr ? `
                        <div class="output-section">
                            <h6><i class="fas fa-exclamation-triangle"></i> Standard Error</h6>
                            <div class="code-block error-output">
${outputData.stderr}
                            </div>
                        </div>
                        ` : ''}

                        ${outputData.error ? `
                        <div class="output-section">
                            <h6><i class="fas fa-times-circle"></i> Error</h6>
                            <div class="alert alert-danger">
                                ${outputData.error}
                            </div>
                        </div>
                        ` : ''}

                        <div class="mt-4 text-center">
                            <button class="btn btn-secondary" onclick="window.close()">
                                <i class="fas fa-times"></i> Đóng
                            </button>
                        </div>
                    </div>
                </body>
                </html>
            `;

            popup.document.write(htmlContent);
            popup.document.close();
        }

        // Copy to clipboard helper
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('success', '✅ Đã copy lệnh vào clipboard!');
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('Không thể copy. Vui lòng copy thủ công: ' + text);
            });
        }

        // Show custom notification
        function showCustomNotification(title, htmlContent) {
            // Create modal if not exists
            let customModal = document.getElementById('customNotificationModal');
            if (!customModal) {
                customModal = document.createElement('div');
                customModal.id = 'customNotificationModal';
                customModal.className = 'modal fade';
                customModal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="customNotificationTitle"></h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" id="customNotificationBody"></div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(customModal);
            }

            document.getElementById('customNotificationTitle').textContent = title;
            document.getElementById('customNotificationBody').innerHTML = htmlContent;

            const modal = new bootstrap.Modal(customModal);
            modal.show();
        }

        // Initialize monitoring clock
        function initMonitoringClock(examEndTime) {
            // Update clock every second
            updateMonitoringClock(examEndTime);
            setInterval(() => updateMonitoringClock(examEndTime), 1000);
        }

        // Update current time and countdown
        function updateMonitoringClock(examEndTime) {
            // Update current time (UTC+7)
            const now = new Date();
            const utc7Time = new Date(now.getTime() + (7 * 60 * 60 * 1000));
            const hours = String(utc7Time.getUTCHours()).padStart(2, '0');
            const minutes = String(utc7Time.getUTCMinutes()).padStart(2, '0');
            const seconds = String(utc7Time.getUTCSeconds()).padStart(2, '0');

            const currentTimeEl = document.getElementById('currentTime');
            if (currentTimeEl) {
                currentTimeEl.textContent = `${hours}:${minutes}:${seconds}`;
            }

            // Update countdown
            if (examEndTime) {
                const endTime = new Date(examEndTime);
                const remaining = endTime - now;

                const countdownEl = document.getElementById('countdown');
                if (countdownEl) {
                    if (remaining <= 0) {
                        countdownEl.textContent = '00:00:00';
                        countdownEl.classList.add('countdown-danger');
                    } else {
                        const totalSeconds = Math.floor(remaining / 1000);
                        const h = Math.floor(totalSeconds / 3600);
                        const m = Math.floor((totalSeconds % 3600) / 60);
                        const s = totalSeconds % 60;

                        countdownEl.textContent = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;

                        // Remove previous classes
                        countdownEl.classList.remove('countdown-warning', 'countdown-danger');

                        // Warning when less than 10 minutes
                        if (remaining < 10 * 60 * 1000) {
                            countdownEl.classList.add('countdown-danger');
                        } else if (remaining < 30 * 60 * 1000) {
                            countdownEl.classList.add('countdown-warning');
                        }
                    }
                }
            }
        }

        // Resize handle functionality
        (function initResizeHandle() {
            const resizeHandle = document.getElementById('resizeHandle');
            const pdfPanel = document.getElementById('pdfPanel');
            const workspaceContainer = document.getElementById('workspaceContainer');
            let isResizing = false;

            resizeHandle.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const containerWidth = document.querySelector('.split-container').offsetWidth;
                const newPdfWidth = (e.clientX / containerWidth) * 100;

                // Giới hạn width từ 20% đến 80%
                if (newPdfWidth >= 20 && newPdfWidth <= 80) {
                    pdfPanel.style.width = newPdfWidth + '%';
                    workspaceContainer.style.width = (100 - newPdfWidth) + '%';
                }
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = 'default';
                }
            });
        })();
    </script>
</body>
</html>

