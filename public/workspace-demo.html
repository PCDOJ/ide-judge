<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workspace Demo - IDE Judge</title>
    <link rel="stylesheet" href="/css/workspace.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Workspace Toolbar -->
    <div class="workspace-toolbar">
        <div class="toolbar-left">
            <button class="btn-workspace btn-back" onclick="goBack()">
                <i class="fas fa-arrow-left"></i> Quay lại
            </button>
            <div class="problem-info">
                <span class="problem-code" id="problem-code">PROB001</span>
                <span> - </span>
                <span id="problem-title">Tổng hai số</span>
            </div>
        </div>
        <div class="toolbar-right">
            <div class="timer" id="timer">
                <i class="fas fa-clock"></i>
                <span id="time-remaining">--:--:--</span>
            </div>
            <button class="btn-workspace btn-view-pdf" onclick="togglePDF()" id="view-pdf-btn" style="display: none;">
                <i class="fas fa-file-pdf"></i> Đề bài
            </button>
            <button class="btn-workspace btn-save" onclick="saveManually()">
                <i class="fas fa-save"></i> Lưu
            </button>
            <button class="btn-workspace btn-submit" onclick="submitCode()">
                <i class="fas fa-paper-plane"></i> Nộp bài
            </button>
        </div>
    </div>

    <!-- Sync Status -->
    <div id="sync-status" class="sync-status idle"></div>

    <!-- Toggle Sidebar Button -->
    <button class="toggle-sidebar-btn" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- File List Sidebar -->
    <div class="file-list-sidebar" id="file-sidebar">
        <div class="sidebar-header">
            <span>Files</span>
            <span id="files-count">0</span>
        </div>
        <div id="file-list">
            <!-- Files will be loaded here -->
        </div>
    </div>

    <!-- Split Container for PDF and Workspace -->
    <div class="split-container">
        <!-- PDF Panel -->
        <div class="pdf-panel hidden" id="pdfPanel">
            <iframe id="pdfViewer" class="pdf-viewer"></iframe>
        </div>

        <!-- Resize Handle -->
        <div class="resize-handle hidden" id="resizeHandle"></div>

        <!-- Workspace Container -->
        <div class="workspace-container fullscreen" id="workspaceContainer">
            <!-- Code-server iframe sẽ được load ở đây -->
            <iframe id="workspace-iframe" class="workspace-iframe" src="about:blank"></iframe>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="workspace-loading" id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">Đang khởi tạo workspace...</div>
    </div>

    <script src="/js/workspace-client.js"></script>
    <script>
        // Global variables
        let workspaceClient = null;
        let contestId = null;
        let problemId = null;
        let problemCode = null;
        window.codeSaved = false; // Track if code has been saved

        // Initialize workspace khi page load
        window.addEventListener('DOMContentLoaded', async () => {
            // Get params from URL
            const urlParams = new URLSearchParams(window.location.search);
            contestId = parseInt(urlParams.get('contestId'));
            problemId = parseInt(urlParams.get('problemId'));
            problemCode = urlParams.get('problemCode');

            // Validate required parameters
            if (!contestId || !problemId) {
                alert('Thiếu thông tin contestId hoặc problemId. Vui lòng mở workspace từ trang exam.');
                window.location.href = '/exams.html';
                return;
            }

            // Set default problemCode if not provided
            if (!problemCode) {
                problemCode = 'PROB' + String(problemId).padStart(3, '0');
            }

            console.log('[Workspace] Initialized with:', { contestId, problemId, problemCode });

            // Update UI
            document.getElementById('problem-code').textContent = problemCode;

            try {
                // Initialize workspace client
                workspaceClient = new WorkspaceClient();
                const session = await workspaceClient.init(contestId, problemId);

                console.log('Workspace initialized:', session);

                // Load code-server iframe directly from port 8080 to avoid proxy origin issues
                const folderPath = `/workspace/${session.workspacePath}`;
                const codeServerUrl = `http://localhost:8080/?folder=${encodeURIComponent(folderPath)}`;

                console.log('[Workspace] Loading code-server iframe:', {
                    folderPath: folderPath,
                    encodedUrl: codeServerUrl,
                    sessionId: session.sessionId,
                    workspacePath: session.workspacePath
                });

                const iframe = document.getElementById('workspace-iframe');

                // Add load event listener to track iframe loading
                iframe.addEventListener('load', () => {
                    console.log('[Workspace] Code-server iframe loaded successfully');
                });

                iframe.addEventListener('error', (e) => {
                    console.error('[Workspace] Code-server iframe load error:', e);
                });

                iframe.src = codeServerUrl;

                // Load file list
                await loadFileList();

                // Start timer
                startTimer(session);

                // Show PDF button (always show since all problems should have PDF)
                document.getElementById('view-pdf-btn').style.display = 'inline-block';

                // Hide loading overlay
                document.getElementById('loading-overlay').style.display = 'none';

            } catch (error) {
                console.error('Workspace initialization error:', error);
                alert('Không thể khởi tạo workspace: ' + error.message);
            }
        });

        // Load file list
        async function loadFileList() {
            try {
                const response = await fetch(`/api/workspace/files/${contestId}/${problemId}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message);
                }

                const fileList = document.getElementById('file-list');
                fileList.innerHTML = '';

                if (data.files.length === 0) {
                    fileList.innerHTML = '<div style="padding: 15px; color: #6c757d; text-align: center;">Chưa có file nào</div>';
                } else {
                    data.files.forEach(file => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item' + (file.is_main_file ? ' main-file' : '');
                        fileItem.innerHTML = `
                            <i class="fas fa-file-code file-icon"></i>
                            <span class="file-name">${file.file_name}</span>
                            <span class="file-size">(${formatFileSize(file.file_size)})</span>
                        `;
                        fileList.appendChild(fileItem);
                    });
                }

                document.getElementById('files-count').textContent = data.files.length;

            } catch (error) {
                console.error('Load file list error:', error);
            }
        }

        // Save manually
        async function saveManually() {
            try {
                // Sync files to server first
                await workspaceClient.syncToServer();

                // Save code to submission
                const response = await fetch('/api/workspace/save-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: workspaceClient.sessionId,
                        contestId: contestId,
                        problemId: problemId
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message);
                }

                await loadFileList();

                // Show success notification
                showNotification('success', 'Đã lưu thành công!');

                // Mark as saved
                window.codeSaved = true;

            } catch (error) {
                console.error('Save error:', error);
                showNotification('error', 'Lưu thất bại: ' + error.message);
            }
        }

        // Submit code
        async function submitCode() {
            if (!confirm('Bạn có chắc muốn nộp bài? Sau khi nộp bạn không thể chỉnh sửa.')) {
                return;
            }

            try {
                const result = await workspaceClient.submitCode();
                alert(`Nộp bài thành công!\n\nSố files: ${result.filesCount}\nFile chính: ${result.mainFile}`);

                // Redirect về trang exam
                setTimeout(() => {
                    window.location.href = `/exam-view.html?id=${contestId}`;
                }, 2000);

            } catch (error) {
                console.error('Submit error:', error);
                alert('Nộp bài thất bại: ' + error.message);
            }
        }

        // Toggle PDF panel
        function togglePDF() {
            const pdfPanel = document.getElementById('pdfPanel');
            const workspaceContainer = document.getElementById('workspaceContainer');
            const resizeHandle = document.getElementById('resizeHandle');
            const toggleBtn = document.getElementById('view-pdf-btn');
            const pdfViewer = document.getElementById('pdfViewer');

            if (pdfPanel.classList.contains('hidden')) {
                // Show PDF
                pdfPanel.classList.remove('hidden');
                workspaceContainer.classList.remove('fullscreen');
                resizeHandle.classList.remove('hidden');
                pdfPanel.style.width = '50%';
                workspaceContainer.style.width = '50%';
                toggleBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Ẩn đề';

                // Load PDF if not loaded yet
                if (!pdfViewer.src || pdfViewer.src === 'about:blank') {
                    pdfViewer.src = `/api/user/problems/${problemId}/pdf#zoom=100`;
                }
            } else {
                // Hide PDF
                pdfPanel.classList.add('hidden');
                pdfPanel.style.width = '0';
                workspaceContainer.classList.add('fullscreen');
                workspaceContainer.style.width = '100%';
                resizeHandle.classList.add('hidden');
                toggleBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Đề bài';
            }
        }

        // Go back
        function goBack() {
            console.log('[Workspace] goBack() called, contestId:', contestId);

            // Validate contestId before redirect
            if (!contestId) {
                console.error('[Workspace] contestId is undefined, redirecting to exams.html');
                window.location.href = '/exams.html';
                return;
            }

            const redirectUrl = `/exam-view.html?id=${contestId}`;
            console.log('[Workspace] Redirecting to:', redirectUrl);

            // Nếu đã lưu thì không hỏi lại
            if (window.codeSaved) {
                window.location.href = redirectUrl;
                return;
            }

            // Nếu chưa lưu thì hỏi
            if (confirm('Bạn có chắc muốn thoát? Code chưa được lưu.')) {
                window.location.href = redirectUrl;
            }
        }

        // Show notification
        function showNotification(type, message) {
            // Tạo notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span>${message}</span>
            `;

            // Thêm vào body
            document.body.appendChild(notification);

            // Hiện notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // Ẩn sau 3 giây
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('file-sidebar');
            sidebar.classList.toggle('collapsed');
        }

        // Start timer
        function startTimer(session) {
            // TODO: Implement countdown timer based on session.expiresAt
            const timerElement = document.getElementById('time-remaining');
            
            function updateTimer() {
                // Placeholder - replace with actual logic
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                timerElement.textContent = `${hours}:${minutes}:${seconds}`;
            }

            updateTimer();
            setInterval(updateTimer, 1000);
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Listen to workspace sync status
        window.addEventListener('workspace-sync-status', (e) => {
            console.log('Sync status:', e.detail.status);
            
            // Reload file list after successful sync
            if (e.detail.status === 'saved') {
                loadFileList();
            }
        });

        // Cleanup khi unload
        window.addEventListener('beforeunload', () => {
            if (workspaceClient) {
                workspaceClient.destroy();
            }
        });

        // Resize handle functionality
        (function initResizeHandle() {
            const resizeHandle = document.getElementById('resizeHandle');
            const pdfPanel = document.getElementById('pdfPanel');
            const workspaceContainer = document.getElementById('workspaceContainer');
            let isResizing = false;

            resizeHandle.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const containerWidth = document.querySelector('.split-container').offsetWidth;
                const newPdfWidth = (e.clientX / containerWidth) * 100;

                // Giới hạn width từ 20% đến 80%
                if (newPdfWidth >= 20 && newPdfWidth <= 80) {
                    pdfPanel.style.width = newPdfWidth + '%';
                    workspaceContainer.style.width = (100 - newPdfWidth) + '%';
                }
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = 'default';
                }
            });
        })();
    </script>
</body>
</html>

